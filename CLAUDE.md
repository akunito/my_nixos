## Overview (for Claude Code)

This is a NixOS flake-based dotfiles repo. Prefer NixOS/Home-Manager modules over imperative commands.

## Critical workflow & invariants

- **Immutability**: never suggest editing `/nix/store` or using `nix-env`, `nix-channel`, `apt`, `yum`.
- **Source of truth**: `flake.nix` and its `inputs` define dependencies.
- **Application workflow**: apply changes via `install.sh` (or `aku sync`), not manual systemd enable/start.
- **Unified flake**: use `nixos-rebuild switch --flake .#PROFILE` (e.g., `.#DESK`, `.#LXC_monitoring`). The `#system` alias uses `.active-profile` for backward compatibility.
- **Flake purity**: prefer repo-relative paths (`./.`) and `self`; avoid absolute host paths inside Nix.
- **SSH agent forwarding**: Always use `-A` flag when connecting to remote machines where git operations may be needed. This forwards your local SSH keys to the remote machine.
  ```bash
  ssh -A user@host    # Enables git push/pull on remote without copying keys
  ```
- **System vs user** (applies to: `**/*.nix`):
  - system-wide packages: `environment.systemPackages`
  - per-user: `home.packages`
  - system services: `services.*`
  - user services/programs: `systemd.user.*` / `programs.*` (Home Manager)
- **Modular configuration (CRITICAL)**:
  - **NEVER** hardcode hostname or profile checks in modules (e.g., `hostname == "nixosaku"`)
  - Use feature flags defined in `lib/defaults.nix` instead
  - Flags default to `false` (or safe value) - profiles explicitly enable what they need
  - GPU-specific code must check `systemSettings.gpuType` ("amd", "intel", "nvidia", "none")
  - Profile configs set flags - modules just consume them
  - Example flags: `gpuType`, `enableDesktopPerformance`, `sddmBreezePatchedTheme`, `atuinAutoSync`

### Remote Deployment (CRITICAL — NEVER skip)

**NEVER** run bare `git pull && nixos-rebuild switch` on remote machines. This breaks because:
- `hardware-configuration.nix` is machine-specific; `git pull` may overwrite it with another machine's UUIDs
- `install.sh` handles hardware-config regeneration, file hardening/softening, docker handling, and rollback

**Always use `deploy.sh` or the `install.sh` pattern:**

```bash
# Option A: Use deploy.sh from the local machine (preferred)
./deploy.sh --profile LAPTOP_L15

# Option B: For LXC containers (passwordless sudo) — single SSH command
ssh -A akunito@<IP> "cd ~/.dotfiles && git fetch origin && git reset --hard origin/main && ./install.sh ~/.dotfiles <PROFILE> -s -u -d -h"

# Option C: For physical machines (laptops/desktops) — requires sudo password
# Tell the user to run on the target machine:
cd ~/.dotfiles && git fetch origin && git reset --hard origin/main && ./install.sh ~/.dotfiles <PROFILE> -s -u
```

**Key points:**
- `git fetch origin && git reset --hard origin/main` (NOT `git pull`) ensures clean state
- `install.sh` regenerates `hardware-configuration.nix` for the current machine
- `-d` (skip docker) keeps containers running — use for LXC containers with running services
- `-h` (skip hardware) skips hardware-config generation — use for LXC containers (no hardware changes)
- `-q` (quick) is shorthand for `-d -h` (backward compatibility)
- **LXC containers**: use `-d -h` (skip docker + skip hardware)
- **Laptops/Desktops**: do NOT use `-d` or `-h` — hardware-config MUST be regenerated on physical machines
- Physical machines (DESK, LAPTOP_*) need sudo password — ask user to run manually or provide password
- See `deploy-servers.conf` for the full server inventory and IP addresses
- `hardware-configuration.nix` is tracked in git (required by flake) but regenerated by `install.sh` for the target machine before building

## Documentation Standards (applies to: all projects using this repo's conventions)

### Mandatory Documentation Practices

**ALL documentation MUST follow these rules across all repositories:**

#### 1. Documentation Location (STRICT)

**README.md Exception (ALLOWED):**
- README.md in project root - project overview
- README.md in ANY subdirectory - explains what that folder contains

**All Other Documentation (MUST be in docs/):**
- **NEVER** create other .md files in project root or subdirectories
- **ALWAYS** use `docs/` directory for comprehensive documentation
- **ALWAYS** follow router/catalog system (00_ROUTER.md + 01_CATALOG.md)

#### 2. Documentation Structure (REQUIRED)
```
<project>/docs/
├── 00_ROUTER.md          # Navigation index (REQUIRED)
├── 01_CATALOG.md         # Metadata catalog (REQUIRED)
├── ARCHITECTURE.md       # System design
├── ENVIRONMENT_SETUP.md  # Development setup
├── DEPLOYMENT.md         # Deployment procedures
├── API.md                # API reference (if applicable)
├── TROUBLESHOOTING.md    # Common issues
└── scripts/
    └── generate_docs_index.py  # Index generator
```

#### 3. Frontmatter (MANDATORY)
Every documentation file MUST have YAML frontmatter:
```yaml
---
id: category.subcategory.identifier  # Stable, unique ID
summary: One-line description         # Concise summary
tags: [tag1, tag2]                   # Lowercase tags
related_files: [path/**]             # File globs (optional)
date: YYYY-MM-DD                     # ISO date
status: draft | published            # Document status
---
```

#### 4. Incremental Updates (CRITICAL)
- **UPDATE existing docs** when adding features/changes - don't create new files
- **APPEND** to existing sections rather than duplicating content
- **REGENERATE** router after changes: `cd docs/scripts && python3 generate_docs_index.py`
- **PRESERVE** document IDs - they are stable identifiers and NEVER change

## Profile Architecture Principles (CRITICAL)

This repository follows a **hierarchical, modular, and centralized** profile architecture:

### 1. Base + Override Pattern
- **Base profiles** (`LAPTOP-base.nix`, `LXC-base-config.nix`) contain common settings
- **Specific profiles** (`LAPTOP_L15-config.nix`, `LXC_plane-config.nix`) override only what's unique
- The unified `flake.nix` contains all profile outputs (e.g., `nixosConfigurations.LAPTOP_L15`)

### 2. Profile Type Inheritance Hierarchy

```
lib/defaults.nix (global defaults)
    │
    ├─► personal/configuration.nix ◄─── work/configuration.nix
    │        │
    │        ├─► DESK-config.nix
    │        │        ├─► DESK_AGA-config.nix
    │        │        └─► DESK_VMDESK-config.nix
    │        │
    │        ├─► LAPTOP-base.nix ◄─── LAPTOP_L15-config.nix
    │        │                    ◄─── LAPTOP_YOGAAKU-config.nix
    │        │                    ◄─── LAPTOP_AGA-config.nix
    │
    ├─► homelab/configuration.nix
    │        │
    │        └─► VMHOME-config.nix
    │
    ├─► LXC-base-config.nix ◄─── LXC_HOME-config.nix
    │                        ◄─── LXC_database-config.nix
    │                        ◄─── LXC_liftcraftTEST-config.nix
    │                        ◄─── LXC_mailer-config.nix
    │                        ◄─── LXC_matrix-config.nix
    │                        ◄─── LXC_monitoring-config.nix
    │                        ◄─── LXC_plane-config.nix
    │                        ◄─── LXC_portfolioprod-config.nix
    │                        ◄─── LXC_proxy-config.nix
    │                        ◄─── LXC_tailscale-config.nix
    │
    ├─► WSL-config.nix (standalone)
    │
    └─► darwin/configuration.nix (macOS/nix-darwin)
             │
             └─► MACBOOK-base.nix ◄─── MACBOOK-KOMI-config.nix
```

### 3. Centralized Software Management (CRITICAL)

All software-related flags MUST be grouped in **two centralized sections**:

#### A. System Settings Section (in systemSettings)
```nix
# ============================================================================
# SOFTWARE & FEATURE FLAGS - Centralized Control
# ============================================================================

# === Package Modules ===
systemBasicToolsEnable = true;      # Basic system tools
systemNetworkToolsEnable = true;    # Advanced networking tools

# === Desktop Environment & Theming ===
enableSwayForDESK = true;
stylixEnable = true;
swwwEnable = true;

# === System Services & Features ===
sambaEnable = true;
sunshineEnable = true;
wireguardEnable = true;
xboxControllerEnable = true;
appImageEnable = true;
gamemodeEnable = true;

# === Development Tools & AI ===
developmentToolsEnable = true;
aichatEnable = true;
nixvimEnabled = true;
lmstudioEnabled = true;
```

#### B. User Settings Section (in userSettings)
```nix
# ============================================================================
# SOFTWARE & FEATURE FLAGS (USER) - Centralized Control
# ============================================================================

# === Package Modules (User) ===
userBasicPkgsEnable = true;         # Basic user packages (browsers, office, etc.)
userAiPkgsEnable = true;            # AI & ML packages (lmstudio, ollama-rocm)

# === Gaming & Entertainment ===
protongamesEnable = true;
starcitizenEnable = true;
GOGlauncherEnable = true;
steamPackEnable = true;
dolphinEmulatorPrimehackEnable = true;
rpcs3Enable = true;
```

### 4. Package Module System

Software is organized into **4 core package modules**:

**System Level:**
- `system/packages/system-basic-tools.nix` (systemBasicToolsEnable)
  - Essential CLI tools: vim, wget, zsh, rsync, cryptsetup, etc.
- `system/packages/system-network-tools.nix` (systemNetworkToolsEnable)
  - Advanced networking: nmap, traceroute, dnsutils, etc.

**User Level:**
- `user/packages/user-basic-pkgs.nix` (userBasicPkgsEnable)
  - Standard applications: browsers, office, communication, etc.
- `user/packages/user-ai-pkgs.nix` (userAiPkgsEnable)
  - AI/ML tools: lmstudio, ollama-rocm

### 5. Profile Configuration Rules

**MUST follow:**
- Software flags MUST be in centralized sections (after systemPackages/homePackages)
- Flags MUST be grouped by topic with clear headers
- Each flag MUST have a descriptive comment
- Base profiles define NO software flags (only common settings)
- Specific profiles explicitly enable what they need
- NEVER duplicate flags across profile and base

**Example Profile Structure:**
```nix
{
  systemSettings = {
    hostname = "nixosaku";
    profile = "personal";
    # ... network, security, etc ...

    systemPackages = pkgs: pkgs-unstable: [
      # Profile-specific packages only
    ];

    # ========================================================================
    # SOFTWARE & FEATURE FLAGS - Centralized Control
    # ========================================================================
    systemBasicToolsEnable = true;
    # ... all system software flags grouped here ...
  };

  userSettings = {
    # ... user config ...

    homePackages = pkgs: pkgs-unstable: [
      # Profile-specific packages only
    ];

    # ========================================================================
    # SOFTWARE & FEATURE FLAGS (USER) - Centralized Control
    # ========================================================================
    userBasicPkgsEnable = true;
    # ... all user software flags grouped here ...
  };
}
```

## Home Manager updates

When modifying Home Manager configuration (user-level modules), apply changes using:

```bash
cd /home/akunito/.dotfiles && ./sync-user.sh
```

This command updates the Home Manager configuration and applies changes without requiring a full system rebuild. Use this for:
- User application configurations (tmux, nixvim, etc.)
- User shell configurations
- User window manager settings
- Any changes in `user/` directory

## Context-aware routing (CRITICAL — read before any work)

**Step 1**: Determine context — check `$ENV_PROFILE` and `git branch --show-current`.

| ENV_PROFILE | Machine | User | Branch |
|-------------|---------|------|--------|
| DESK | nixosaku (192.168.8.96) | akunito | main |
| LAPTOP_L15 | nixolaptopaku (192.168.8.92) | akunito | main |
| LAPTOP_AGA | nixosaga (192.168.8.78) | akunito | main |
| LXC_HOME | nixosLabaku (192.168.8.80) | akunito | main |
| LXC_database | database (192.168.8.103) | akunito | main |
| LXC_monitoring | monitoring (192.168.8.85) | akunito | main |
| LXC_proxy | proxy (192.168.8.102) | akunito | main |
| LXC_matrix | matrix (192.168.8.104) | akunito | main |
| LXC_tailscale | tailscale (192.168.8.105) | akunito | main |
| VMHOME | nixosLabaku (192.168.8.80) | akunito | main |
| MACBOOK_KOMI | (macOS) | komi | komi |

**Step 2**: Route to the right reference:

- **akunito** (DESK, LAPTOP_*, LXC_*, VMHOME): use the **Infrastructure & Service Reference** section below for operational docs
- **komi** (MACBOOK_KOMI): use the **Darwin/macOS Reference** section below; skip infrastructure sections

**Step 3**: For any architectural or implementation question, follow the Router-first protocol:
1. Read `docs/00_ROUTER.md` and select the most relevant ID(s)
2. Read the documentation file(s) corresponding to those IDs
3. Only then read the related source files
4. Only if still needed: search, scoped to the selected node's directories

**Step 4**: When working from a remote node (e.g., LXC_matrix via Matrix bot):
```bash
ssh -A akunito@192.168.8.96  # DESK
ssh -A akunito@192.168.8.80  # LXC_HOME
ssh -A akunito@192.168.8.103 # LXC_database
ssh -A root@192.168.8.82     # Proxmox
```

### Multi-user file scoping

| Context | Allowed file scopes |
|---------|---------------------|
| akunito (main) | All except `secrets/komi/`, `MACBOOK-KOMI-config.nix`, `komi-init.lua` |
| komi (komi) | `profiles/MACBOOK-*`, `profiles/darwin/*`, `system/darwin/*`, `user/app/hammerspoon/komi-*`, `secrets/komi/`, `.claude/commands/` |

**Rules for komi:**
- CAN freely modify: darwin-specific files, MACBOOK-KOMI profile, komi-init.lua
- CAN add darwin guards to shared modules (`lib.mkIf isDarwin` / `lib.optionals !isDarwin`)
- MUST NOT modify: `secrets/domains.nix`, LXC profiles, `system/app/` services, `flake.nix`
- MUST NOT remove Linux functionality from shared modules

**Rules for akunito:**
- CAN freely modify: all Linux/NixOS infrastructure
- MUST NOT modify: `secrets/komi/`, `MACBOOK-KOMI-config.nix`, `komi-init.lua`
- SHOULD test darwin eval after touching shared modules

**Shared module changes** (files under `user/`, `lib/`, `system/` but not `system/darwin/`):
- Always use platform guards: `lib.mkIf (!pkgs.stdenv.isDarwin)` for Linux-only
- Never comment out packages globally — use `lib.optionals` with platform check
- Use feature flags for optional features (default false, each profile enables)

**Merge skill:** Use `/merge-branches` to safely merge between branches

## Domain-specific rules

### Unified Flake Architecture

This repository uses a **unified flake.nix** with all profiles and inputs defined in one place:

```
flake.nix                    # Unified flake with all profiles and inputs
├── lib/flake-unified.nix    # Generates nixosConfigurations/darwinConfigurations
├── lib/flake-base.nix       # Profile builder (unchanged)
└── profiles/*-config.nix    # Profile configurations (unchanged)
```

**Key benefits:**
- No more `flake.PROFILE.nix` → `flake.nix` copy workflow
- Single `flake.lock` for atomic dependency updates
- Direct rebuild: `nixos-rebuild switch --flake .#DESK`
- Backward compat: `.#system` alias reads `.active-profile`

**Usage:**
```bash
# Rebuild specific profile
sudo nixos-rebuild switch --flake .#DESK --impure
sudo nixos-rebuild switch --flake .#LXC_monitoring --impure

# Backward compatible (uses .active-profile)
sudo nixos-rebuild switch --flake .#system --impure

# List available profiles
nix eval .#nixosConfigurations --apply 'x: builtins.attrNames x'

# darwin (macOS)
darwin-rebuild switch --flake .#MACBOOK-KOMI
```

### Secrets management (applies to: `secrets/*.nix`, `profiles/*-config.nix`, `system/**/*.nix`)

- **Read first**: `docs/security/git-crypt.md`
- **Encrypted secrets**: `secrets/domains.nix` contains sensitive data (domains, IPs, SNMP, emails)
- **Public template**: `secrets/domains.nix.template` shows structure without real values
- **Import pattern for profiles**:
  ```nix
  let
    secrets = import ../secrets/domains.nix;
  in
  {
    systemSettings = {
      notificationToEmail = secrets.alertEmail;
      prometheusSnmpCommunity = secrets.snmpCommunity;
    };
  }
  ```
- **Import pattern for system modules**:
  ```nix
  let
    secrets = import ../../secrets/domains.nix;
  in
  {
    services.grafana.settings.server.domain = "monitor.${secrets.localDomain}";
  }
  ```
- **Key location**: `~/.git-crypt/dotfiles-key`
- **Unlock on fresh clone**: `git-crypt unlock ~/.git-crypt/dotfiles-key`
- **NEVER commit**: git-crypt keys, plaintext secrets, or credentials

### Documentation encryption (applies to: `docs/**/*.md`, `.gitattributes`)

- **Public docs are OK for**: Internal IPs (192.168.x.x, 172.x.x.x, 10.x.x.x), email addresses, service descriptions, interface names
- **MUST encrypt**: Public IPs, WireGuard keys, passwords, API tokens, SNMP community strings
- **Encryption methods**:
  1. Add sensitive content to `docs/akunito/infrastructure/INFRASTRUCTURE_INTERNAL.md` (already encrypted)
  2. Or add new file to `.gitattributes` with `filter=git-crypt diff=git-crypt`
- **Template pattern**: For encrypted docs with complex structure, create a `.template` version showing structure without real values
- **Verify encryption**: Run `git-crypt status` to confirm files are encrypted before pushing

## Infrastructure & Service Reference

> **Audience**: akunito (NixOS infrastructure). komi: skip this section.

For operational details, **read the service doc first** before SSH-ing or making changes.

### Service index

| Service | Access | Doc |
|---------|--------|-----|
| pfSense | `ssh admin@192.168.8.1` | `docs/akunito/infrastructure/services/pfsense.md` |
| VPS / WireGuard | `ssh -A -p 56777 root@172.26.5.155` | `docs/akunito/infrastructure/services/vps-wireguard.md` |
| Grafana / Prometheus | LXC_monitoring `192.168.8.85` | `docs/akunito/infrastructure/services/monitoring-stack.md` |
| Matrix | `ssh -A akunito@192.168.8.104` | `docs/akunito/infrastructure/services/matrix.md` |
| Tailscale / Headscale | `ssh -A akunito@192.168.8.105` | `docs/akunito/infrastructure/services/tailscale-headscale.md` |
| Uptime Kuma (local) | `http://192.168.8.89:3001` | `docs/akunito/infrastructure/services/kuma.md` |
| Uptime Kuma (public) | `https://status.akunito.com` | `docs/akunito/infrastructure/services/kuma.md` |
| Database / Redis | `ssh -A akunito@192.168.8.103` | `docs/akunito/infrastructure/services/database-redis.md` |
| Network / 10GbE | USW Agg `192.168.8.180` | `docs/akunito/infrastructure/services/network-switching.md` |
| Proxy / Tunnel | `ssh -A akunito@192.168.8.102` | `docs/akunito/infrastructure/services/proxy-stack.md` |
| Infrastructure overview | (all containers, IPs) | `docs/akunito/infrastructure/INFRASTRUCTURE.md` |
| Infrastructure audits | (date-stamped reports) | `docs/akunito/infrastructure/audits/` |

### Module & hardware reference

| Topic | Doc |
|-------|-----|
| Sway session services | `docs/user-modules/sway-daemon-integration.md` |
| Gaming (Proton, Steam, SC) | `docs/user-modules/gaming.md` |
| Power / TLP / Hibernate | `docs/akunito/hardware/cpu-power-management.md`, `docs/akunito/system-modules/hibernate.md` |
| Thunderbolt dock / 10GbE | `docs/user-modules/thunderbolt-dock.md` |
| Docker-based projects | `docs/akunito/infrastructure/docker-projects.md` |

## Darwin/macOS Reference

> **Audience**: komi (macOS/darwin). akunito: skip this section unless touching shared modules.

- **Read first**: `docs/komi/macos-installation.md` and `docs/komi/macos-komi-migration.md`
- **Cross-platform modules**: When modifying `user/`, `lib/`, or `system/`:
  - Use `pkgs.stdenv.isDarwin` / `lib.mkIf (!pkgs.stdenv.isDarwin)` for platform guards
  - Never break existing Linux functionality when adding darwin support
  - Never comment out packages globally — use `lib.optionals` with platform check
- **Apply workflow**: `darwin-rebuild switch --flake .#MACBOOK-KOMI`
- **Homebrew for GUI apps**: Use `systemSettings.darwin.homebrewCasks` for GUI apps, Nix for CLI tools
- **Key darwin settings**: `homebrewCasks`, `dockAutohide`, `dockOrientation`, `touchIdSudo`, `keyboardKeyRepeat`

## Project-specific rules

External project repositories (Portfolio, LiftCraft, Plane, etc.) may have their
own CLAUDE.md with project-specific conventions. When working in those repos:

- The project's CLAUDE.md takes precedence for project-specific rules
- This dotfiles CLAUDE.md governs NixOS infrastructure and profile configuration
- Docker-based project conventions: `docs/akunito/infrastructure/docker-projects.md`
- Connection details and secrets: use this repo's secrets management patterns

## Multi-agent instructions

For complex tasks, see `.claude/agents/` for agent-specific context and patterns.
