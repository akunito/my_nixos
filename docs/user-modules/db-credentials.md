---
id: user-modules.db-credentials
summary: Home Manager module for database credential files (pgpass, my.cnf, redis)
tags: [database, credentials, postgresql, mariadb, redis, dbeaver, home-manager]
related_files: [user/app/database/db-credentials.nix, profiles/DESK-config.nix, profiles/LAPTOP_L15-config.nix]
---

# Database Credentials Module

This Home Manager module generates standard database credential files for passwordless CLI access to the centralized LXC_database server.

## Overview

The module generates:
- `~/.pgpass` - PostgreSQL password file (for `psql` CLI and PgBouncer)
- `~/.my.cnf` - MariaDB/MySQL configuration file (for `mysql` CLI)
- `~/.redis-credentials` - Redis connection details (sourced by scripts)

## Configuration

### Profile Settings

Enable in profile config (`profiles/DESK-config.nix`, `profiles/LAPTOP_L15-config.nix`):

```nix
let
  secrets = import ../secrets/domains.nix;
in
{
  systemSettings = {
    # ... other settings ...

    # === Database Client Credentials ===
    dbCredentialsEnable = true;
    dbCredentialsHost = "192.168.8.103"; # LXC_database server
    dbCredentialsPostgres = [
      { database = "plane"; user = "plane"; password = secrets.dbPlanePassword; }
      { database = "rails_database_prod"; user = "liftcraft"; password = secrets.dbLiftcraftPassword; }
    ];
    dbCredentialsMariadb = [
      { database = "nextcloud"; user = "nextcloud"; password = secrets.dbNextcloudPassword; }
    ];
    dbCredentialsRedisPassword = secrets.redisServerPassword;
  };
}
```

### Flag Reference

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `dbCredentialsEnable` | bool | `false` | Enable credential file generation |
| `dbCredentialsHost` | string | `"192.168.8.103"` | Database server IP |
| `dbCredentialsPostgres` | list | `[]` | PostgreSQL credentials: `[{database, user, password}]` |
| `dbCredentialsMariadb` | list | `[]` | MariaDB credentials: `[{database, user, password}]` |
| `dbCredentialsRedisPassword` | string | `""` | Redis server password |

## Generated Files

### ~/.pgpass

PostgreSQL password file format (`hostname:port:database:username:password`):

```
# PostgreSQL password file
# Generated by NixOS Home Manager

192.168.8.103:5432:plane:plane:<password>
192.168.8.103:6432:plane:plane:<password>
192.168.8.103:5432:rails_database_prod:liftcraft:<password>
192.168.8.103:6432:rails_database_prod:liftcraft:<password>
```

Both direct PostgreSQL (5432) and PgBouncer (6432) connections are included.

### ~/.my.cnf

MariaDB/MySQL client configuration:

```ini
[client]
host = 192.168.8.103
port = 3306
user = nextcloud
password = <password>

[mysql]
database = nextcloud

[mysqldump]
host = 192.168.8.103
port = 3306
user = nextcloud
password = <password>
```

### ~/.redis-credentials

Sourceable shell file:

```bash
REDIS_HOST=192.168.8.103
REDIS_PORT=6379
REDIS_PASSWORD=<password>
```

## Shell Aliases

The module adds convenient shell aliases:

| Alias | Command |
|-------|---------|
| `psql-plane` | Connect to Plane database |
| `psql-liftcraft` | Connect to LiftCraft database |
| `mysql-nextcloud` | Connect to Nextcloud database |
| `redis-db` | Connect to Redis with authentication |

## Security

- All credential files are created with mode `0600` (owner read/write only)
- PostgreSQL requires `~/.pgpass` to be mode `0600` or it will be ignored
- Credential files are managed by Home Manager and regenerated on each rebuild
- Passwords are sourced from `secrets/domains.nix` which is git-crypt encrypted

## Usage

### PostgreSQL

```bash
# Passwordless connection using ~/.pgpass
psql -h 192.168.8.103 -U plane -d plane

# Or use shell alias
psql-plane

# Via PgBouncer (connection pooling)
psql -h 192.168.8.103 -p 6432 -U plane -d plane
```

### MariaDB

```bash
# Passwordless connection using ~/.my.cnf
mysql

# Or specify database
mysql nextcloud

# Or use shell alias
mysql-nextcloud
```

### Redis

```bash
# Source credentials and connect
source ~/.redis-credentials
redis-cli -h $REDIS_HOST -p $REDIS_PORT -a "$REDIS_PASSWORD"

# Or use shell alias
redis-db
```

## DBeaver Integration

DBeaver may not directly read `~/.pgpass` or `~/.my.cnf`. To configure DBeaver:

1. Use the `/update-dbeaver` skill to sync connections
2. Enter passwords manually on first connection
3. DBeaver will save passwords in its encrypted credential store

See `.claude/commands/update-dbeaver.md` for detailed DBeaver configuration.

## Deployment

After updating profile configuration:

```bash
# Rebuild Home Manager (DESK)
cd ~/.dotfiles && ./sync-user.sh

# Or full system rebuild
cd ~/.dotfiles && ./install.sh ~/.dotfiles DESK -s -u
```

## Troubleshooting

### psql: FATAL: password authentication failed

1. Check `~/.pgpass` exists and has correct permissions:
   ```bash
   ls -la ~/.pgpass
   # Should be: -rw------- (mode 600)
   ```

2. Verify file content matches expected credentials:
   ```bash
   cat ~/.pgpass | head -5
   ```

3. Rebuild Home Manager to regenerate:
   ```bash
   cd ~/.dotfiles && ./sync-user.sh
   ```

### mysql: Access denied

1. Check `~/.my.cnf` exists:
   ```bash
   ls -la ~/.my.cnf
   ```

2. Verify credentials match server:
   ```bash
   ssh -A akunito@192.168.8.103 "sudo mysql -e 'SELECT User, Host FROM mysql.user;'"
   ```

### Redis connection refused

1. Verify Redis is running on LXC_database:
   ```bash
   ssh -A akunito@192.168.8.103 "systemctl status redis-homelab"
   ```

2. Check network connectivity:
   ```bash
   nc -zv 192.168.8.103 6379
   ```

## Related Documentation

- [Centralized Database Server](/docs/infrastructure/services/database-server.md)
- [Git-Crypt Secrets](/docs/security/git-crypt.md)
- [Profile Feature Flags](/docs/profile-feature-flags.md)
